
name: CI

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    branches:
      - "**"
      - "!release/**"

jobs:
  # 1. Secret scanning with Gitleaks
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # 2. Python jobs (lint, format, type-check, test, build)
  python-lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Ruff
        run: pipx install ruff
      - name: Lint code with Ruff
        run: ruff check --output-format=github --target-version=py312 api/

  python-format:
    name: Python Format Check (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Ruff
        run: pipx install ruff
      - name: Check code formatting with Ruff
        run: ruff format --check --target-version=py312 api/

  python-typecheck:
    name: Python Type Check (ty)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Set up Python
        run: uv python install 3.12
      - name: Install dependencies
        run: uv sync --all-groups
      - name: Type check with ty
        run: uv run ty check api/

  python-test:
    name: Python Tests (Pytest)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v5
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}
      - name: Install dependencies
        run: uv sync --all-groups
      - name: Run tests with pytest
        run: uv run pytest api/tests/ --cov=api --cov-report=xml --junitxml=junit/test-results-${{ matrix.python-version }}.xml
      - name: Upload pytest test results
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results-${{ matrix.python-version }}
          path: junit/test-results-${{ matrix.python-version }}.xml
        if: ${{ always() }}
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml
        if: ${{ always() }}

  python-build:
    name: Python Build (Docker)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: vigil:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  # 3. React jobs (lint, format, type-check, test, build)
  react-lint:
    name: React Lint (oxlint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v5
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Lint with oxlint
        run: bun run lint

  react-format:
    name: React Format Check (oxfmt)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v5
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Check formatting with oxfmt
        run: bun run format:check

  react-typecheck:
    name: React Type Check (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v5
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Type check with TypeScript
        run: bun run tsc --noEmit

  react-build:
    name: React Build (Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v5
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Build with Vite
        run: bun run build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: web/dist/

  react-docker-build:
    name: React Build (Docker)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./web
          file: ./web/Dockerfile
          push: false
          load: true
          tags: vigil-web:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

  # 4. Final check - all jobs passed
  ci-passed:
    name: CI Passed
    runs-on: ubuntu-latest
    needs:
      - gitleaks
      - python-lint
      - python-format
      - python-typecheck
      - python-test
      - python-build
      - react-lint
      - react-format
      - react-typecheck
      - react-build
      - react-docker-build
    steps:
      - name: All checks passed
        run: echo "âœ… All CI checks passed successfully!"
