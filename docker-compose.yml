services:
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: vigil-web
    ports:
      - "3000:80"
    networks:
      - scanner-net
    restart: unless-stopped
    depends_on:
      - api

  api:
    build: .
    container_name: vigil-api
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app/api:ro
      - ./outputs:/app/outputs:rw
      - ./config:/app/config:ro
      - ./vigil.db:/app/vigil.db:rw
      - ./alembic:/app/alembic:ro
      - ./alembic.ini:/app/alembic.ini:ro
    environment:
      - DEBUG=true
      - LOG_LEVEL=INFO
    networks:
      - scanner-net
    restart: unless-stopped
    depends_on:
      - zap
      - nuclei
      - nikto

  # ZAP daemon for Python API client
  zap:
    image: zaproxy/zap-stable:latest
    container_name: security-scanner-zap
    volumes:
      - ./outputs:/zap/wrk:rw
    command: >
      zap.sh -daemon -host 0.0.0.0 -port 8090
      -config api.disablekey=true
      -config api.addrs.addr.name=.*
      -config api.addrs.addr.regex=true
    networks:
      - scanner-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090"]
      interval: 10s
      timeout: 5s
      retries: 5

  nuclei:
    image: projectdiscovery/nuclei:latest
    container_name: security-scanner-nuclei
    volumes:
      - ./outputs:/output:rw
      - nuclei-templates:/root/nuclei-templates
    entrypoint: ["/bin/sh", "-c"]
    command: ["tail -f /dev/null"]
    networks:
      - scanner-net
    restart: unless-stopped

  nikto:
    image: alpine/nikto:latest
    container_name: security-scanner-nikto
    volumes:
      - ./outputs:/output:rw
    entrypoint: ["/bin/sh", "-c"]
    command: ["tail -f /dev/null"]
    networks:
      - scanner-net
    restart: unless-stopped

  ffuf:
    image: secsi/ffuf:latest
    container_name: security-scanner-ffuf
    volumes:
      - ./outputs:/output:rw
      - ./config/wordlists:/wordlists:ro
    entrypoint: ["/bin/sh", "-c"]
    command: ["tail -f /dev/null"]
    networks:
      - scanner-net
    restart: unless-stopped

volumes:
  nuclei-templates:
    driver: local

networks:
  scanner-net:
    driver: bridge
